{% extends 'base.html' %}
{% load static %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Заголовок и статус -->
    <div class="chat-header">
        <h1 class="gradient-title">
            <i class="fas fa-comments mr-2"></i>Чат с {{ object.broker.get_full_name }}
        </h1>
        <div class="status-indicator">
            <span class="status-badge status-{{ object.status }}">{{ object.get_status_display }}</span>
            <div class="typing-indicator" id="typingIndicator"></div>
        </div>
    </div>

    <!-- История сообщений с пагинацией -->
    <div class="message-history" id="messageContainer">
        {% include 'accounts/partials/messages_list.html' %}
    </div>

    <!-- Форма отправки сообщений -->
    {% if object.status != 'completed' %}
    <div class="message-form-container">
        <form id="chatForm" method="post" action="{% url 'add_message' object.pk %}" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Цитирование сообщения -->
            <div class="quote-preview" id="quotePreview"></div>

            <!-- Основные поля формы -->
            <div class="form-group">
                <textarea name="text" id="messageInput" class="form-control"
                    placeholder="Напишите сообщение..." rows="3" required></textarea>

                <div class="attachment-controls">
                    <label class="file-upload-btn">
                        <input type="file" name="attachment" id="fileInput"
                            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        <i class="fas fa-paperclip"></i>
                    </label>
                    <span class="file-info" id="fileInfo"></span>
                </div>
            </div>

            <button type="submit" class="btn-send" id="submitBtn">
                <i class="fas fa-paper-plane mr-2"></i>Отправить
            </button>
        </form>
    </div>
    {% else %}
    <div class="chat-closed-alert">
        <i class="fas fa-lock mr-2"></i>Чат завершен
    </div>
    {% endif %}
</div>

<!-- Пагинация -->
{% if messages.has_other_pages %}
<div class="pagination-container">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if messages.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ messages.previous_page_number }}">Назад</a>
            </li>
            {% endif %}

            {% for num in messages.paginator.page_range %}
            <li class="page-item {% if num == messages.number %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}

            {% if messages.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ messages.next_page_number }}">Вперед</a>
            </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // WebSocket подключение
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/{{ object.id }}/'
    );

    // Обработчик ввода текста
    const messageInput = document.getElementById('messageInput');
    let typingTimeout;

    messageInput.addEventListener('input', () => {
        chatSocket.send(JSON.stringify({
            'type': 'typing',
            'user_id': '{{ request.user.id }}'
        }));

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            document.getElementById('typingIndicator').textContent = '';
        }, 1500);
    });

    // Обработчик файлов
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            if (file.size > 10 * 1024 * 1024) {
                alert('Файл слишком большой (макс. 10MB)');
                e.target.value = '';
            }
            document.getElementById('fileInfo').textContent = file.name;
        }
    });

    // Обработчик отправки формы
    document.getElementById('chatForm').addEventListener('submit', () => {
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = `
            <i class="fas fa-spinner fa-spin"></i> Отправка...
        `;
    });

    // WebSocket обработчики
    chatSocket.onmessage = (e) => {
        const data = JSON.parse(e.data);

        if (data.type === 'message') {
            const container = document.getElementById('messageContainer');
            container.insertAdjacentHTML('beforeend', data.html);
            container.scrollTop = container.scrollHeight;
        }

        if (data.type === 'typing') {
            document.getElementById('typingIndicator').textContent =
                `${data.username} печатает...`;
        }
    };

    chatSocket.onclose = (e) => {
        console.error('Chat socket closed unexpectedly');
    };
</script>
{% endblock %}